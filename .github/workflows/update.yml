name: Update Videos JSON

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */3 * * *'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Convert playlist.m3u8 to videos.json
        run: |
          python3 <<EOF
          import json
          videos = []

          with open("playlist.m3u8", "r") as f:
              lines = f.readlines()

          for i in range(len(lines)):
              if lines[i].startswith("#EXTINF"):
                  title = lines[i].split(",")[-1].strip()
                  url = lines[i+1].strip()

                  videos.append({
                      "title": title,
                      "url": url,
                      "duration": 0
                  })

          with open("videos.json", "w") as f:
              json.dump(videos, f, indent=2)
          EOF

      - name: Commit JSON
        run: |
          git config --global user.name "actions-user"
          git config --global user.email "actions@github.com"
          git add videos.json
          git commit -m "Update videos.json" || echo "No changes"
          git push
